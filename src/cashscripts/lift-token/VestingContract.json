{
  "contractName": "VestingContract",
  "constructorInputs": [
    {
      "name": "buyer",
      "type": "bytes20"
    },
    {
      "name": "tokenId",
      "type": "bytes32"
    },
    {
      "name": "adminPubkey",
      "type": "pubkey"
    },
    {
      "name": "lockupEnd",
      "type": "int"
    },
    {
      "name": "totalTokenAmount",
      "type": "int"
    }
  ],
  "abi": [
    {
      "name": "claim",
      "inputs": []
    },
    {
      "name": "emergencyTransfer",
      "inputs": [
        {
          "name": "buyerPubkey",
          "type": "pubkey"
        },
        {
          "name": "buyerSig",
          "type": "sig"
        },
        {
          "name": "adminSig",
          "type": "sig"
        },
        {
          "name": "newScriptHash",
          "type": "bytes32"
        }
      ]
    }
  ],
  "bytecode": "OP_5 OP_PICK OP_0 OP_NUMEQUAL OP_IF 50cd00 OP_4 OP_DIV OP_0 OP_OUTPOINTINDEX OP_1ADD OP_DUP OP_1 OP_GREATERTHANOREQUAL OP_OVER OP_4 OP_LESSTHANOREQUAL OP_BOOLAND OP_VERIFY OP_5 OP_ROLL OP_OVER OP_3 OP_ROLL OP_MUL OP_ADD OP_CHECKLOCKTIMEVERIFY OP_DROP OP_4 OP_PICK OP_4 OP_DIV OP_5 OP_ROLL OP_4 OP_MOD OP_OVER OP_3 OP_ROLL OP_4 OP_NUMEQUAL OP_IF OP_2 OP_PICK OP_2 OP_PICK OP_ADD OP_NIP OP_ENDIF OP_TXINPUTCOUNT OP_2 OP_NUMEQUALVERIFY OP_0 OP_UTXOTOKENCATEGORY OP_5 OP_PICK OP_EQUALVERIFY OP_0 OP_UTXOTOKENAMOUNT OP_OVER OP_NUMEQUALVERIFY OP_1 OP_UTXOVALUE OP_0 OP_GREATERTHAN OP_VERIFY OP_1 OP_UTXOTOKENAMOUNT OP_0 OP_NUMEQUALVERIFY OP_TXOUTPUTCOUNT OP_2 OP_NUMEQUALVERIFY 76a914 OP_4 OP_ROLL OP_CAT 88ac OP_CAT OP_0 OP_OUTPUTBYTECODE OP_EQUALVERIFY OP_0 OP_OUTPUTTOKENCATEGORY OP_4 OP_ROLL OP_EQUALVERIFY OP_0 OP_OUTPUTTOKENAMOUNT OP_NUMEQUALVERIFY OP_1 OP_OUTPUTVALUE OP_0 OP_GREATERTHAN OP_VERIFY OP_1 OP_OUTPUTTOKENAMOUNT OP_0 OP_NUMEQUALVERIFY OP_2DROP OP_2DROP OP_1 OP_ELSE OP_5 OP_ROLL OP_1 OP_NUMEQUALVERIFY OP_5 OP_PICK OP_HASH160 OP_EQUALVERIFY OP_2ROT OP_CHECKSIGVERIFY OP_4 OP_ROLL OP_ROT OP_CHECKSIGVERIFY OP_TXINPUTCOUNT OP_2 OP_NUMEQUALVERIFY OP_0 OP_UTXOTOKENCATEGORY OP_OVER OP_EQUALVERIFY OP_1 OP_UTXOVALUE OP_0 OP_GREATERTHAN OP_VERIFY OP_1 OP_UTXOTOKENAMOUNT OP_0 OP_NUMEQUALVERIFY OP_TXOUTPUTCOUNT OP_2 OP_NUMEQUALVERIFY OP_0 OP_OUTPUTTOKENCATEGORY OP_EQUALVERIFY OP_1 OP_OUTPUTVALUE OP_0 OP_GREATERTHAN OP_VERIFY OP_1 OP_OUTPUTTOKENAMOUNT OP_0 OP_NUMEQUALVERIFY aa20 OP_3 OP_ROLL OP_CAT 87 OP_CAT OP_0 OP_OUTPUTBYTECODE OP_EQUALVERIFY OP_0 OP_OUTPUTTOKENCATEGORY OP_0 OP_UTXOTOKENCATEGORY OP_EQUALVERIFY OP_0 OP_OUTPUTTOKENAMOUNT OP_0 OP_UTXOTOKENAMOUNT OP_NUMEQUAL OP_NIP OP_NIP OP_ENDIF",
  "source": "pragma cashscript ^0.11.5;\n\n/**\n * VestingContract (v2) â€” Option A\n *\n * Goal:\n * - Exactly one vesting contract instance (one address/script) per purchase.\n * - The swap produces 4 separate UTXOs to this same contract address (one per quarter/tranche).\n * - `claim()` is permissionless (no buyer signature), but value cannot be redirected due to\n *   strict output constraints.\n *\n * How tranche index is determined:\n * - Each tranche UTXO is expected to be created at a known vout in the swap tx (0..3).\n * - On claim, we require there is exactly 1 input, so `tx.inputs[0]` is the tranche UTXO.\n * - We derive quarter from `tx.inputs[0].outpointIndex + 1`.\n *\n * Params:\n * - buyer: hash160(buyerPubkey)\n * - tokenId: token category id (CashTokens category)\n * - adminPubkey: admin public key\n * - lockupEnd: block height when lockup ends (vesting starts)\n * - totalTokenAmount: total token amount purchased for this vesting schedule (token base units)\n */\ncontract VestingContract(\n    bytes20 buyer,\n    bytes32 tokenId,\n    pubkey adminPubkey,\n    int lockupEnd,\n    int totalTokenAmount\n) {\n    function claim() {\n        int constant BLOCKS_PER_YEAR = 52560;\n        int constant BLOCKS_PER_QUARTER = BLOCKS_PER_YEAR / 4;\n\n        // Quarter derived from the spent UTXO's previous output index (expected 0..3)\n        int quarter = tx.inputs[0].outpointIndex + 1;\n        require(quarter >= 1 && quarter <= 4, \"Invalid quarter index\");\n\n        int unlockBlock = lockupEnd + (quarter * BLOCKS_PER_QUARTER);\n        require(tx.time >= unlockBlock, \"Vesting not yet unlocked\");\n\n        // Compute expected tranche amount (last tranche carries remainder)\n        int base = totalTokenAmount / 4;\n        int remainder = totalTokenAmount % 4;\n        int expected = base;\n        if (quarter == 4) {\n            expected = base + remainder;\n        }\n\n        // Bind tranche selection to the actual spent tranche UTXO by requiring a single input.\n        // Another input is expected to be the BCH UTXO for the network fee\n        require(tx.inputs.length == 2, \"Unexpected inputs\");\n\n        // require 0th input as the tranche UTXO\n        require(tx.inputs[0].tokenCategory == tokenId, \"Incorrect token ID\");\n        require(tx.inputs[0].tokenAmount == expected, \"Incorrect token amount\");\n\n        // require 1st input as the BCH UTXO\n        require(tx.inputs[1].value > 0, \"1st input is not BCH\");\n        require(tx.inputs[1].tokenAmount == 0, \"1st input is not BCH\");\n\n        // Strict single-output prevents token/BCH leakage to other outputs.\n        // Another output is expected for change output\n        require(tx.outputs.length == 2, \"Unexpected outputs\");\n\n        bytes25 buyerP2pkh = new LockingBytecodeP2PKH(buyer);\n        require(tx.outputs[0].lockingBytecode == buyerP2pkh, \"Output not sent to buyer\");\n\n        require(tx.outputs[0].tokenCategory == tokenId, \"Incorrect token ID\");\n        require(tx.outputs[0].tokenAmount == expected, \"Incorrect token amount\");\n\n        // require 1st output as BCH only, but it can be sent to any address\n        require(tx.outputs[1].value > 0, \"1st output is not BCH\");\n        require(tx.outputs[1].tokenAmount == 0, \"1st output is not BCH\");\n    }\n\n    // Buyer+admin emergency migration to a new contract version (P2SH32).\n    function emergencyTransfer(pubkey buyerPubkey, sig buyerSig, sig adminSig, bytes32 newScriptHash) {\n        // Bind buyer identity (prevents \"any signer\" bypass)\n        require(hash160(buyerPubkey) == buyer, \"Only buyer can approve\");\n        require(checkSig(buyerSig, buyerPubkey), \"Invalid buyer signature\");\n        require(checkSig(adminSig, adminPubkey), \"Only admin can approve\");\n\n        // Keep this spend simple and non-leaky\n        // 0th input and output are expected to be the tranche UTXO\n        // 1st input and output are expected to be the BCH UTXO for the network fee\n        require(tx.inputs.length == 2, \"Unexpected inputs\");\n        require(tx.inputs[0].tokenCategory == tokenId, \"Incorrect token ID\");\n        require(tx.inputs[1].value > 0, \"1st input is not BCH\");\n        require(tx.inputs[1].tokenAmount == 0, \"1st input is not BCH\");\n        require(tx.outputs.length == 2, \"Unexpected outputs\");\n        require(tx.outputs[0].tokenCategory == tokenId, \"Incorrect token ID\");\n        require(tx.outputs[1].value > 0, \"1st output is not BCH\");\n        require(tx.outputs[1].tokenAmount == 0, \"1st output is not BCH\");\n\n        bytes35 newLock = new LockingBytecodeP2SH32(newScriptHash);\n        require(tx.outputs[0].lockingBytecode == newLock, \"Receiver is incorrect\");\n\n        // Preserve token category and amount when migrating this tranche UTXO\n        require(tx.outputs[0].tokenCategory == tx.inputs[0].tokenCategory, \"Unequal token ID\");\n        require(tx.outputs[0].tokenAmount == tx.inputs[0].tokenAmount, \"Unequal token amount\");\n    }\n}\n",
  "debug": {
    "bytecode": "5579009c630350cd00549600c98b7651a27854a19a69557a78537a9593b17554795496557a549778537a549c6352795279937768c3529d00ce55798800d0789d51c600a06951d0009dc4529d0376a914547a7e0288ac7e00cd8800d1547a8800d39d51cc00a06951d3009d6d6d5167557a519d5579a98871ad547a7badc3529d00ce788851c600a06951d0009dc4529d00d18851cc00a06951d3009d02aa20537a7e01877e00cd8800d100ce8800d300d09c777768",
    "sourceMap": "31:4:75:5;;;;;32:39:32:44;33:60:33:61;:42:::1;36:32:36:33:0;:22::48:1;:::52;37:16:37:23:0;:27::28;:16:::1;:32::39:0;:43::44;:32:::1;:16;:8::71;39:26:39:35:0;;:39::46;:49::67;;:39:::1;:26::68;40:8:40;;43:19:43:35:0;;:38::39;:19:::1;44:24:44:40:0;;:43::44;:24:::1;45:23:45:27:0;46:12:46:19;;:23::24;:12:::1;:26:48:9:0;47:23:47:27;;:30::39;;:23:::1;:12::40;46:26:48:9;52:16:52:32:0;:36::37;:8::60:1;55:26:55:27:0;:16::42:1;:46::53:0;;:8::77:1;56:26:56:27:0;:16::40:1;:44::52:0;:8::80:1;59:26:59:27:0;:16::34:1;:37::38:0;:16:::1;:8::64;60:26:60:27:0;:16::40:1;:44::45:0;:8::71:1;64:16:64:33:0;:37::38;:8::62:1;66:29:66:60:0;:54::59;;:29::60:1;;;67:27:67:28:0;:16::45:1;:8::89;69:27:69:28:0;:16::43:1;:47::54:0;;:8::78:1;70:27:70:28:0;:16::41:1;:8::81;73:27:73:28:0;:16::35:1;:38::39:0;:16:::1;:8::66;74:27:74:28:0;:16::41:1;:45::46:0;:8::73:1;31:4:75:5;;;;78::102::0;;;;80:24:80:35;;:16::36:1;:8::73;81:25:81:46:0;:8::76:1;82:25:82:33:0;;:35::46;:8::75:1;87:16:87:32:0;:36::37;:8::60:1;88:26:88:27:0;:16::42:1;:46::53:0;:8::77:1;89:26:89:27:0;:16::34:1;:37::38:0;:16:::1;:8::64;90:26:90:27:0;:16::40:1;:44::45:0;:8::71:1;91:16:91:33:0;:37::38;:8::62:1;92:27:92:28:0;:16::43:1;:8::78;93:27:93:28:0;:16::35:1;:38::39:0;:16:::1;:8::66;94:27:94:28:0;:16::41:1;:45::46:0;:8::73:1;96:26:96:66:0;:52::65;;:26::66:1;;;97:27:97:28:0;:16::45:1;:8::83;100:27:100:28:0;:16::43:1;:57::58:0;:47::73:1;:8::95;101:27:101:28:0;:16::41:1;:55::56:0;:45::69:1;:8::95;78:4:102:5;;24:0:103:1",
    "logs": [],
    "requires": [
      {
        "ip": 23,
        "line": 37,
        "message": "Invalid quarter index"
      },
      {
        "ip": 31,
        "line": 40,
        "message": "Vesting not yet unlocked"
      },
      {
        "ip": 56,
        "line": 52,
        "message": "Unexpected inputs"
      },
      {
        "ip": 61,
        "line": 55,
        "message": "Incorrect token ID"
      },
      {
        "ip": 65,
        "line": 56,
        "message": "Incorrect token amount"
      },
      {
        "ip": 70,
        "line": 59,
        "message": "1st input is not BCH"
      },
      {
        "ip": 74,
        "line": 60,
        "message": "1st input is not BCH"
      },
      {
        "ip": 77,
        "line": 64,
        "message": "Unexpected outputs"
      },
      {
        "ip": 86,
        "line": 67,
        "message": "Output not sent to buyer"
      },
      {
        "ip": 91,
        "line": 69,
        "message": "Incorrect token ID"
      },
      {
        "ip": 94,
        "line": 70,
        "message": "Incorrect token amount"
      },
      {
        "ip": 99,
        "line": 73,
        "message": "1st output is not BCH"
      },
      {
        "ip": 103,
        "line": 74,
        "message": "1st output is not BCH"
      },
      {
        "ip": 115,
        "line": 80,
        "message": "Only buyer can approve"
      },
      {
        "ip": 117,
        "line": 81,
        "message": "Invalid buyer signature"
      },
      {
        "ip": 121,
        "line": 82,
        "message": "Only admin can approve"
      },
      {
        "ip": 124,
        "line": 87,
        "message": "Unexpected inputs"
      },
      {
        "ip": 128,
        "line": 88,
        "message": "Incorrect token ID"
      },
      {
        "ip": 133,
        "line": 89,
        "message": "1st input is not BCH"
      },
      {
        "ip": 137,
        "line": 90,
        "message": "1st input is not BCH"
      },
      {
        "ip": 140,
        "line": 91,
        "message": "Unexpected outputs"
      },
      {
        "ip": 143,
        "line": 92,
        "message": "Incorrect token ID"
      },
      {
        "ip": 148,
        "line": 93,
        "message": "1st output is not BCH"
      },
      {
        "ip": 152,
        "line": 94,
        "message": "1st output is not BCH"
      },
      {
        "ip": 161,
        "line": 97,
        "message": "Receiver is incorrect"
      },
      {
        "ip": 166,
        "line": 100,
        "message": "Unequal token ID"
      },
      {
        "ip": 172,
        "line": 101,
        "message": "Unequal token amount"
      }
    ]
  },
  "compiler": {
    "name": "cashc",
    "version": "0.11.5"
  },
  "updatedAt": "2026-01-20T02:05:14.945Z"
}